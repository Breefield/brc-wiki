# LocalWiki Apache config file
# After modifying and saving, you may need to run these commands:
#     $ sudo a2ensite example.com
#     $ sudo /etc/init.d/apache2 reload

<VirtualHost *:8084>

    ServerAdmin {{ server_admin_email }}

    WSGIDaemonProcess localwiki processes=2 threads=15 maximum-requests=10000 user=www-data group=www-data display-name=%{GROUP}
    WSGIProcessGroup localwiki
    # For API Authorization header support
    WSGIPassAuthorization On

    WSGIScriptAlias / {{ localwiki_root }}/localwiki.wsgi

    CustomLog /var/log/apache2/access.log combined
    
    SetEnv no-gzip  # Doesn't play well with Varnish:
    #  If the content is gzip'ed, then Varnish won't add a Content-Length
    #  header, which means KeepAlive effectively won't work. Bad. So we
    #  only do gziping when the response comes /out/ of apache at the
    #  very end here (*:443 VirtualHost below).

    KeepAlive Off

</VirtualHost>

# Redirect HTTP -> HTTPS
<VirtualHost *:80>
    ServerName {{ public_hostname }}
    ServerAlias www.{{ public_hostname }}
    ServerAlias *.{{ public_hostname }}
    {% for domain in custom_domains %}
    ServerAlias {{ domain }}
    {% endfor %}

    ServerAdmin {{ server_admin_email }}

    # Redirect www -> no-www
    RewriteEngine on
    RewriteCond %{HTTPS} off
    RewriteRule (.*) https://{{ public_hostname }}%{REQUEST_URI} [R=301]
</VirtualHost>

<VirtualHost *:443>
    # Virtualhost for routing to either:
    #   1) Static assets, served via apache directly.
    #   2) Application URLs, proxied to varnish first.
    #      a) Varnish will then use localhost:8084
    #         to get the application content.

    ServerName {{ public_hostname }}
    ServerAlias www.{{ public_hostname }}
    ServerAlias *.{{ public_hostname }}
    {% for domain in custom_domains %}
    ServerAlias {{ domain }}
    {% endfor %}

    ServerAdmin {{ server_admin_email }}

    Include extra-conf/ssl.conf
    Include extra-conf/localwiki_certs.conf
    # Enable this if your want HSTS (recommended, but be careful)
    # Header add Strict-Transport-Security "max-age=15768000"

    # Redirect www -> no-www
    RewriteEngine on
    RewriteCond %{HTTP_HOST} ^www\.(.*)$ [NC]
    RewriteRule ^(.*)$ http://%1$1 [R=301,L]

    <Location /server-status>
        SetHandler server-status
        Order deny,allow
        Deny from all
        Allow from 127.0.0.1 ::1
    #    Allow from 192.0.2.0/24
    </Location>

    # The media directory, which contains user-uploaded content, should be set
    # to force downloads. This is *extremely* important for security reasons.
    # Note: The /media/ directory must be writable by the www-data user
    Alias /media/ {{ data_root }}/media/
    <Location /media/>
        Header set Content-Disposition attachment
    </Location>

    Alias /static/ {{ data_root }}/static/
    Alias /robots.txt {{ data_root }}/static/robots.txt
    Alias /sitemap.xml {{ data_root }}/static/sitemap.xml
    Alias /favicon.ico {{ data_root }}/static/favicon.ico

    # Make sure we send Expires and Cache-control headers for
    # static & media content.
    <Location /media/>
        ExpiresDefault "access plus 1 year"
        ExpiresActive On
    </Location>
    <Location /static/>
        ExpiresDefault "access plus 1 year"
        ExpiresActive On
    </Location>

    <Directory {{ data_root }}>
        Options -Indexes FollowSymLinks MultiViews
        AllowOverride None
        Order allow,deny
        Allow from all
    </Directory>

    <Proxy *>
        Order deny,allow
        Allow from all
    </Proxy>
    ProxyRequests off

    # Route to varnish, except for some static assets
    ProxyPass /static/ !
    ProxyPass /media/ !
    ProxyPass /robots.txt !
    ProxyPass /sitemap.xml !
    ProxyPass /_monitoring/ !
    ProxyPass /favicon.ico !
    ProxyPass /apple-touch-icon.png !
    ProxyPass /apple-touch-icon.png/ !
    ProxyPass / http://127.0.0.1:6081/ keepalive=On retry=0

    ProxyPassReverse /static/ !
    ProxyPassReverse /media/ !
    ProxyPassReverse /static/ !
    ProxyPassReverse /robots.txt !
    ProxyPassReverse /sitemap.xml !
    ProxyPassReverse /_monitoring/ !
    ProxyPassReverse /favicon.ico !
    ProxyPassReverse /apple-touch-icon.png !
    ProxyPassReverse /apple-touch-icon.png/ !
    ProxyPassReverse / http://127.0.0.1:6081/ keepalive=On

    RequestHeader set X-Forwarded-Proto "https"

    CustomLog /var/log/apache2/access.log combined

</VirtualHost>
